<!-- MODAL (Reusable Component) -->
<div x-show="$store.modal.isOpen" x-trap.noscroll="$store.modal.isOpen" @keydown.escape.window="$store.modal.close()"
    class="fixed inset-0 bg-primary-blue bg-opacity-75 z-50 flex items-center justify-center p-4" x-cloak>
    <div @click.outside="$store.modal.close()" class="bg-white rounded-lg shadow-xl w-full max-w-lg"
        x-show="$store.modal.isOpen" x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0 scale-90" x-transition:enter-end="opacity-100 scale-100"
        x-transition:leave="transition ease-in duration-200" x-transition:leave-start="opacity-100 scale-100"
        x-transition:leave-end="opacity-0 scale-90">

        <div class="p-6 md:p-8 relative">
            <button @click="$store.modal.close()" aria-label="Close modal"
                class="absolute top-4 right-4 text-gray-400 hover:text-gray-700 text-3xl leading-none">&times;</button>

            <!-- FORM VIEW -->
            <div x-show="!$store.modal.isSuccess">
                <h3 class="font-sans text-2xl font-bold text-primary-blue mb-2">Get My Certainty Quote</h3>
                <p class="text-gray-600 mb-8">Start the process below. A secure link to continue will be sent to your
                    email.</p>

                <form id="quote-form" @submit.prevent="$store.modal.submitForm()" class="space-y-6">
                    <div class="grid sm:grid-cols-2 gap-6">
                        <!-- Full Name -->
                        <div class="relative">
                            <input type="text" id="modal-name" name="name" required class="form-input-live peer"
                                placeholder=" " />
                            <label for="modal-name" class="form-label-live">Full Name</label>
                        </div>
                        <!-- Email Address -->
                        <div class="relative">
                            <input type="email" id="modal-email" name="email" required class="form-input-live peer"
                                placeholder=" " />
                            <label for="modal-email" class="form-label-live">Email Address</label>
                        </div>
                    </div>
                    <!-- Destination -->
                    <div class="relative">
                        <select id="modal-destination" name="country" required class="form-input-live peer">
                            <option value=""></option>
                            <option value="zimbabwe">Zimbabwe</option>
                            <option value="zambia">Zambia</option>
                            <option value="malawi">Malawi</option>
                        </select>
                        <label for="modal-destination" class="form-label-live">Destination Country</label>
                    </div>

                    <!-- Required Delivery Date (with Smart Positioning) -->
                    <div x-data="datepicker(null)" @click.outside="isOpen = false" class="relative">
                        <input type="hidden" name="delivery_date" x-model="selectedDate">
                        <div class="relative">
                            <input @click="isOpen = !isOpen; repositionCalendar()" type="text" id="modal-delivery-date"
                                readonly :value="formatDate(selectedDate)" class="form-input-live peer cursor-pointer"
                                placeholder=" " />
                            <label for="modal-delivery-date" class="form-label-live">Required Delivery Date</label>
                            <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none"><i
                                    class="fas fa-calendar-alt text-gray-400"></i></div>
                        </div>

                        <div x-ref="calendarContainer" x-show="isOpen" x-transition class="datepicker-container">
                            <div class="flex justify-between items-center mb-2">
                                <button type="button" @click="prevMonth()" class="p-2 rounded-full hover:bg-gray-100"><i
                                        class="fas fa-chevron-left fa-sm text-gray-600"></i></button>
                                <div class="font-semibold text-primary-blue" x-text="`${monthNames[month]} ${year}`">
                                </div>
                                <button type="button" @click="nextMonth()" class="p-2 rounded-full hover:bg-gray-100"><i
                                        class="fas fa-chevron-right fa-sm text-gray-600"></i></button>
                            </div>
                            <div class="grid grid-cols-7 gap-1 text-center text-sm">
                                <template x-for="day in dayLabels">
                                    <div class="font-medium text-gray-500" x-text="day"></div>
                                </template>
                                <template x-for="blank in blankDays">
                                    <div></div>
                                </template>
                                <template x-for="day in daysInMonth">
                                    <button type="button" @click="selectDate(day)"
                                        class="h-9 w-9 flex items-center justify-center rounded-full"
                                        :class="{'bg-secondary-orange text-white': isSelected(day), 'hover:bg-gray-100': !isSelected(day) && !isToday(day), 'text-primary-blue font-bold': isToday(day) && !isSelected(day)}"
                                        x-text="day"></button>
                                </template>
                            </div>
                        </div>
                    </div>

                    <!-- Hazchem Checkbox -->
                    <div class="flex items-center pt-2"><input id="modal-hazchem" name="is_hazchem" type="checkbox"
                            value="true"
                            class="h-5 w-5 text-secondary-orange rounded border-gray-300 focus:ring-secondary-orange"><label
                            for="modal-hazchem" class="ml-3 block text-base text-gray-700">This is a hazardous materials
                            shipment</label></div>

                    <button type="submit" class="w-full btn-primary" :disabled="$store.modal.isLoading">
                        <span x-show="!$store.modal.isLoading"
                            class="flex items-center justify-center gap-2"><span>Start My Quote</span><i
                                class="fas fa-arrow-right fa-sm"></i></span>
                        <span x-show="$store.modal.isLoading" class="flex items-center justify-center"><i
                                class="fas fa-spinner fa-spin mr-2"></i> Generating Secure Link...</span>
                    </button>
                </form>
            </div>

            <!-- SUCCESS & CONFIRMATION VIEW -->
            <div x-show="$store.modal.isSuccess" class="text-center py-4">
                <i class="fas fa-envelope-circle-check text-5xl text-green-500 mb-4"></i>
                <h3 class="font-sans text-2xl font-bold text-primary-blue">Link Sent to Your Inbox!</h3>
                <p class="text-gray-600 mt-2 mb-6">A secure link to continue your quote has been sent to your email. You
                    can complete it now, or finish it later at your convenience.</p>

                <div class="text-left bg-light-grey p-4 rounded-lg">
                    <h4 class="font-bold text-primary-blue mb-2">To complete your quote, you will need:</h4>
                    <ul class="space-y-1.5 text-sm text-gray-700">
                        <li class="flex items-center gap-2"><i
                                class="fa-solid fa-check-circle text-secondary-orange"></i> Cargo Weight & Product
                            Description</li>
                        <li class="flex items-center gap-2"><i
                                class="fa-solid fa-check-circle text-secondary-orange"></i> Collection & Delivery
                            Address(es)</li>
                        <li class="flex items-center gap-2"><i
                                class="fa-solid fa-check-circle text-secondary-orange"></i> Your Contact Phone Number
                        </li>
                    </ul>
                </div>

                <div class="mt-8 flex flex-col sm:flex-row gap-4">
                    <button @click="$store.modal.continueToQuote()" class="btn-primary w-full">
                        <i class="fa-solid fa-circle-arrow-right mr-2"></i> Continue Now
                    </button>
                    <button @click="$store.modal.close()" class="btn-secondary w-full">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- STICKY CTA (Reusable Component) -->
<button @click="$store.modal.open()"
    class="fixed bottom-6 right-6 bg-secondary-orange text-white font-sans font-bold py-3 px-5 rounded-full shadow-lg hover:bg-orange-600 transition-all transform hover:scale-110 z-30 flex items-center gap-2">
    <i class="fas fa-comment-dots"></i><span class="hidden sm:inline">Get My Certainty Quote</span>
</button>